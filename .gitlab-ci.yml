    before_script:
      - IMAGE_TAG="$(echo $CI_COMMIT_SHA | head -c 8)"

    cache:
      paths:
        - maven.repository/
    
    variables:
      MAVEN_OPTS: "-Djava.awt.headless=true -Dmaven.repo.local=maven.repository/"
      MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
      REPOSITORY_URL: 523059994343.dkr.ecr.sa-east-1.amazonaws.com/git

    stages:
  #    - unit-test
  #    - integration-test
      - package
      - deploy

  #  maven-unit-test:
  #    image: maven:3-jdk-8
  #    stage: unit-test
  #    script:
  #      - mvn $MAVEN_CLI_OPTS clean test -P unit-test

  #  maven-integration-test:
  #    image: maven:3-jdk-11
  #    services:
  #      - name: amazon/dynamodb-local
  #        alias: dynamodblocal
  #    stage: integration-test
  #    script:
  #      - mvn $MAVEN_CLI_OPTS install -P integration-test -Dspring.profiles.active=CI -Dskip.startlocaldynamo=true
  #      - mkdir target/dependency
  #      - (cd target/dependency; jar -xf ../*.jar)
  #    artifacts:
  #      paths:
  #        - target/*.jar
  #        - target/dependency
  #        - target/cucumber-reports/cucumber-html-reports/*

    build-image:
      image: docker:latest
      stage: package
      services:
        - name: docker:dind
      script:
        - apk add --no-cache curl jq python3 py-pip
        - pip install awscli
        - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
        - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
        - aws configure set region $AWS_DEFAULT_REGION
      #  - docker login -u AWS -p $(aws ecr get-login-password --region sa-east-1) 523059994343.dkr.ecr.sa-east-1.amazonaws.com
        - $(aws ecr get-login --region sa-east-1)
        - docker build -t $REPOSITORY_URL:latest .
        - docker tag $REPOSITORY_URL:latest $REPOSITORY_URL:$IMAGE_TAG
        - docker push $REPOSITORY_URL:latest
        - docker push $REPOSITORY_URL:$IMAGE_TAG


    deploy:
      image: python:latest
      stage: deploy
      script:
        - pip install awscli
        - echo $REPOSITORY_URL:$IMAGE_TAG
        - aws ecs register-task-definition --region sa-east-1 --family MyTaskDef --cli-input-json file://aws/ecs-task-definition.json
        - aws ecs update-service --region sa-east-1 --cluster MyCluster --service MyService  --task-definition MyTaskDef
